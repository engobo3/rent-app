rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ──────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isLandlord() {
      return isAuthenticated() && getUserRole() == 'landlord';
    }

    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }

    // ─── User Profiles ─────────────────────────────────────────────────
    match /users/{userId} {
      // Users can read their own profile; admins can read all
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Users can create their own profile on first login
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Users can update their own profile (but not change role); admins can update any
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && request.resource.data.role == resource.data.role) ||
        isAdmin()
      );
      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }

    // ─── Properties ────────────────────────────────────────────────────
    match /properties/{propertyId} {
      // Anyone authenticated can read properties
      allow read: if isAuthenticated();
      // Landlords can create properties they own; admins can create any
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isAdmin());
      // Only the owner or admin can update/delete
      allow update, delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }

    // ─── Units ─────────────────────────────────────────────────────────
    match /units/{unitId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isAdmin());
      allow update, delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }

    // ─── Tenants ───────────────────────────────────────────────────────
    match /tenants/{tenantId} {
      // Tenants can read their own record; landlords can read their tenants; admins read all
      allow read: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        isOwner(resource.data.ownerId) ||
        isAdmin()
      );
      // Landlords can create tenants they own; admins can create any
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isAdmin());
      // Owner landlord, the tenant themselves, or admin can update
      allow update: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        resource.data.email == request.auth.token.email ||
        isAdmin()
      );
      // Only owner landlord or admin can delete
      allow delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }

    // ─── Listings (Public Read) ────────────────────────────────────────
    match /listings/{listingId} {
      // Public: anyone can read listings
      allow read: if true;
      // Only the owner landlord or admin can write
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isAdmin());
      allow update, delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }

    // ─── Applications ──────────────────────────────────────────────────
    match /applications/{appId} {
      // Public: anyone can create an application (no auth required)
      allow create: if true;
      // Owner landlord or admin can read/update/delete
      allow read: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
      allow update, delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }

    // ─── Expenses ──────────────────────────────────────────────────────
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isAdmin());
      allow update, delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }

    // ─── Repairs ───────────────────────────────────────────────────────
    match /repairs/{repairId} {
      // Tenants can read their own repairs; landlords read their property repairs; admins read all
      allow read: if isAuthenticated() && (
        resource.data.tenantId == request.auth.uid ||
        isOwner(resource.data.ownerId) ||
        isAdmin()
      );
      // Tenants can create repair requests; landlords and admins can too
      allow create: if isAuthenticated();
      // Owner landlord or admin can update (resolve repairs)
      allow update: if isAuthenticated() && (
        isOwner(resource.data.ownerId) ||
        resource.data.tenantId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (isOwner(resource.data.ownerId) || isAdmin());
    }
  }
}
